<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover" />
  <title>ÂßøÂ∑ù„Éì„É≥„Ç¥</title>

  <!-- ZXing („Éñ„É©„Ç¶„Ç∂Âêë„ÅëQRË™≠„ÅøÂèñ„Çä„É©„Ç§„Éñ„É©„É™) -->
  <script src="https://unpkg.com/@zxing/browser@0.1.1/umd/index.min.js"></script>

  <style>
    :root{
      --bg: #f9f9f9;
      --card: #ffffff;
      --accent: #fdd835;
      --accent-border: #fbc02d;
      --btn: #007aff;
      --danger: #e53935;
    }
    html,body{
      height:100%;
      margin:0;
      padding:0;
      background:var(--bg);
      font-family: "Hiragino Kaku Gothic ProN","„Éí„É©„ÇÆ„ÉéËßí„Ç¥ ProN W3", "Noto Sans JP",sans-serif;
      -webkit-font-smoothing:antialiased;
      -webkit-user-select:none;
      user-select:none;
    }

    header{
      display:flex;
      justify-content:center;
      align-items:center;
      padding:12px 8px 6px 8px;
    }

    h1{
      font-size:20px;
      margin:0;
      color:#222;
    }

    main{ display:flex; flex-direction:column; align-items:center; gap:8px; padding-bottom:80px; }

    /* board */
    #board{
      display:grid;
      grid-template-columns: repeat(5, minmax(48px, 1fr));
      gap:8px;
      width: min(92vw, 420px);
      margin-top:6px;
      box-sizing:border-box;
    }

    .cell{
      background:var(--card);
      border:2px solid #ccc;
      border-radius:10px;
      height: min(18vw, 72px);
      min-height:48px;
      display:flex;
      align-items:center;
      justify-content:center;
      font-weight:700;
      color:#111;
      font-size: clamp(14px, 3.3vw, 18px);
      transition: transform .18s ease, box-shadow .18s ease;
      box-sizing:border-box;
      touch-action: manipulation;
    }

    .cell.marked{
      background: var(--accent);
      border-color: var(--accent-border);
      color:#111;
      box-shadow: 0 0 16px rgba(255,200,0,0.8);
      transform: scale(1.05);
      animation: shine 0.6s ease;
    }

    @keyframes shine{
      0%{ transform: scale(1.18); filter:brightness(1.6); opacity:0.95;}
      100%{ transform: scale(1); filter:brightness(1); opacity:1;}
    }

    /* message (BINGO etc) */
    #status{
      position: fixed;
      top: 38%;
      left: 50%;
      transform: translate(-50%,-50%);
      background: rgba(255,255,255,0.95);
      padding: 10px 18px;
      border-radius: 10px;
      font-weight: 900;
      font-size: 28px;
      color:#d81b60;
      display:none;
      z-index: 1200;
      box-shadow: 0 8px 30px rgba(0,0,0,0.15);
      text-align:center;
    }

    /* scan button fixed bottom */
    #scanBtn{
      position: fixed;
      left: 50%;
      transform: translateX(-50%);
      bottom: 12px;
      width: calc(100% - 28px);
      max-width: 420px;
      height: 56px;
      border-radius: 12px;
      border: none;
      background: var(--btn);
      color: #fff;
      font-size: 18px;
      font-weight:700;
      z-index: 1100;
      box-shadow: 0 6px 18px rgba(0,0,0,0.12);
      touch-action: manipulation;
    }

    /* camera full screen modal */
    #cameraModal{
      position: fixed;
      inset: 0;
      background: #000;
      display: none;
      align-items: center;
      justify-content: center;
      z-index: 2000;
      flex-direction: column;
    }

    #cameraModal video{
      width: 100%;
      height: 100%;
      object-fit: cover;
      transform: scaleX(-1); /* mirror off; will flip in code if necessary */
    }

    #closeCamera{
      position: absolute;
      top: 18px;
      right: 14px;
      z-index:2100;
      background: rgba(0,0,0,0.45);
      color: #fff;
      border: none;
      padding: 8px 12px;
      border-radius: 8px;
      font-size: 18px;
    }

    /* responsive spacing */
    .spacer{ height:14px; }

    @media (min-width:700px){
      #scanBtn{ bottom: 18px; height:62px; }
      .cell{ min-height:72px; }
    }
  </style>
</head>
<body>
  <header><h1>ÂßøÂ∑ù„Éì„É≥„Ç¥</h1></header>

  <main>
    <div id="board" aria-hidden="false"></div>
    <div class="spacer"></div>
    <div id="status" role="status" aria-live="polite"></div>
  </main>

  <button id="scanBtn" aria-label="QR„Ç≥„Éº„Éâ„ÇíË™≠„ÅøÂèñ„Çã">üì∑ QR„Ç≥„Éº„Éâ„ÇíË™≠„ÅøÂèñ„Çã</button>

  <!-- „Ç´„É°„É©ÂÖ®ÁîªÈù¢ -->
  <div id="cameraModal" aria-hidden="true">
    <video id="video" playsinline autoplay></video>
    <button id="closeCamera" aria-label="„Ç´„É°„É©„ÇíÈñâ„Åò„Çã">Èñâ„Åò„Çã</button>
  </div>

<script>
/*
  ÂÆåÂÖ®‰∏Ä‰ΩìÂûã„Ç≥„Éº„Éâ
  - QR„Éá„Éº„Çø: B1 ... B25Ôºà‰∏≠Â§ÆB13„ÅØFREE„ÅßQR„Å™„ÅóÔºâ
  - Âãï‰Ωú: „Éú„Çø„É≥Êäº„Åô ‚Üí ÂÖ®ÁîªÈù¢„Ç´„É°„É© ‚Üí QRÊ§úÂá∫ ‚Üí „Ç´„É°„É©ÂÅúÊ≠¢‚ÜíÁõ§Èù¢Ë°®Á§∫‚Üí„Éû„ÇπÁÇπÁÅØ
  - „É©„Ç§„Éñ„É©„É™: @zxing/browser (CDNË™≠„ÅøËæº„Åø)
*/

(async ()=>{

// DOM
const boardEl = document.getElementById('board');
const scanBtn = document.getElementById('scanBtn');
const cameraModal = document.getElementById('cameraModal');
const video = document.getElementById('video');
const closeCamera = document.getElementById('closeCamera');
const statusEl = document.getElementById('status');

const ROWS = 5;
const COLS = 5;
const TOTAL = ROWS * COLS;
const FREE_INDEX = 12; // 0-based center
let cells = []; // {el, value, marked}
let usedLineKeys = new Set();

let codeReader = null;
let currentStream = null;

// helper show status
function showStatus(text, persistent=false){
  statusEl.textContent = text;
  statusEl.style.display = 'block';
  if (!persistent) {
    setTimeout(()=> {
      statusEl.style.display = 'none';
      statusEl.textContent = '';
    }, 2000);
  }
}

// build board
function buildBoard(){
  boardEl.innerHTML = '';
  cells = [];
  let n = 1;
  for (let i=0;i<TOTAL;i++){
    const div = document.createElement('div');
    div.className = 'cell';
    if (i === FREE_INDEX){
      div.textContent = 'FREE';
      div.classList.add('marked');
      cells.push({el:div, value:'FREE', marked:true});
    } else {
      const code = `B${n}`;
      div.textContent = code;
      cells.push({el:div, value:code, marked:false});
      n++;
    }
    boardEl.appendChild(div);
  }
}
buildBoard();


// bingo check lines
const LINES = [];
// rows
for (let r=0;r<ROWS;r++){
  const idx = [];
  for (let c=0;c<COLS;c++) idx.push(r*COLS + c);
  LINES.push(idx);
}
// cols
for (let c=0;c<COLS;c++){
  const idx = [];
  for (let r=0;r<ROWS;r++) idx.push(r*COLS + c);
  LINES.push(idx);
}
// diagonals
LINES.push([0,6,12,18,24]);
LINES.push([4,8,12,16,20]);

function checkBingoAndShow(){
  const marked = cells.map(s => s.marked);
  let newLines = 0;
  LINES.forEach((line, idx)=>{
    const key = line.join(',');
    if (!usedLineKeys.has(key) && line.every(i=> marked[i])) {
      usedLineKeys.add(key);
      newLines++;
    }
  });

  if (usedLineKeys.size === LINES.length){
    showStatus('üéØ COMPLETE! üéØ', true);
    return;
  }

  if (newLines > 0){
    const txt = newLines === 1 ? 'üéâ BINGO! üéâ' : `‚ú® ${newLines}„É©„Ç§„É≥ BINGO! ‚ú®`;
    showStatus(txt, false);
  }
}

// mark cell by code like "B7"
function markByCode(code){
  if (!code) return;
  code = String(code).trim();
  if (!/^B\d{1,2}$/.test(code)) return;
  const num = parseInt(code.slice(1),10);
  if (isNaN(num) || num < 1 || num > 25) return;
  const idx = num - 1;
  if (idx === FREE_INDEX) return; // FREE has no QR and is already marked
  const target = cells[idx];
  if (!target) return;
  if (target.marked) return;
  target.marked = true;
  target.el.classList.add('marked');
  checkBingoAndShow();
}

// camera utilities
async function startCameraAndScan(){
  // safety: must be called by user gesture (scanBtn click)
  cameraModal.style.display = 'flex';
  cameraModal.setAttribute('aria-hidden','false');

  // create reader if not exist
  if (!window.ZXingBrowser) {
    // if ZXing not loaded, fallback: show error
    showStatus('QR„É©„Ç§„Éñ„É©„É™„ÅåË™≠„ÅøËæº„Åæ„Çå„Å¶„ÅÑ„Åæ„Åõ„Çì', false);
    return;
  }

  codeReader = new ZXingBrowser.BrowserMultiFormatReader();

  try {
    // list video devices
    const devices = await ZXingBrowser.BrowserMultiFormatReader.listVideoInputDevices();
    // prefer back camera
    let chosen = devices.find(d => /back|rear|Áí∞Â¢É|Back/i.test(d.label)) || devices[0];
    // decode from device directly to video element; callback when found
    await codeReader.decodeFromVideoDevice(chosen.deviceId, video, (result, err) => {
      if (result) {
        // got code
        const text = result.text;
        try {
          // stop and close camera
          stopCamera();
        } catch(e){}
        // small delay to let UI stabilize
        setTimeout(()=> {
          markByCode(text);
        }, 120);
      }
      // err are ignored (noisy)
    });
  } catch (e) {
    console.error('camera start error', e);
    showStatus('„Ç´„É°„É©„ÅåËµ∑Âãï„Åß„Åç„Åæ„Åõ„Çì', false);
    closeCameraModal();
  }
}

function stopCamera(){
  try {
    if (codeReader) { codeReader.reset(); }
  } catch(e){}
  // stop any MediaStream tracks
  if (video && video.srcObject) {
    const s = video.srcObject;
    if (s.getTracks) s.getTracks().forEach(t => t.stop());
    video.srcObject = null;
  }
  closeCameraModal();
}

function closeCameraModal(){
  cameraModal.style.display = 'none';
  cameraModal.setAttribute('aria-hidden','true');
}

// events
scanBtn.addEventListener('click', async (e) => {
  // user gesture -> start camera
  await startCameraAndScan();
});
closeCamera.addEventListener('click', () => {
  stopCamera();
});

// accessibility: hide modal on escape
document.addEventListener('keydown', (ev)=> {
  if (ev.key === 'Escape') stopCamera();
});

// initial: mark FREE cell visually already done in buildBoard
// ensure board layout sizing for small screens: adjust grid cell sizes based on viewport
function adjustGrid(){
  // handled by CSS using min() and vw; no runtime change needed
}
window.addEventListener('resize', adjustGrid);

})(); // IIFE end
</script>
</body>
</html>
