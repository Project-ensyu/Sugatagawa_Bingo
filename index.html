<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width,initial-scale=1.0,user-scalable=no">
<title>BINGO PROJECT</title>

<style>
body {
    font-family: sans-serif;
    background: #111;
    color: #fff;
    margin: 0;
    text-align: center;
}
#bingo-board {
    display: grid;
    grid-template-columns: repeat(5, 60px);
    grid-gap: 6px;
    margin: 20px auto;
    width: 320px;
}
.cell {
    width: 60px;
    height: 60px;
    background: #333;
    border-radius: 10px;
    display:flex;
    align-items:center;
    justify-content:center;
    font-size:22px;
    font-weight:bold;
    transition: 0.4s;
}
.glow {
    background: #0f0 !important;
    box-shadow: 0 0 15px #0f0;
}
#scanBtn {
    background: #2196f3;
    border:none;
    padding:14px 25px;
    border-radius:10px;
    font-size:20px;
    margin-top: 15px;
    color:#fff;
}
#camera-view {
    display:none;
    position:fixed;
    top:0;left:0;width:100%;height:100%;
    background:#000;
    z-index:9999;
    justify-content:center;
    align-items:center;
}
#video {
    width:100vw;
    height:100vh;
    object-fit:cover;
}
#closeCam {
    position: fixed;
    top:20px;right:20px;
    background:#f00;
    border:none;
    font-size:18px;
    padding:10px 14px;
    border-radius:8px;
    color:#fff;
}
.message {
    font-size: 40px;
    font-weight:bold;
    position:fixed;
    top:40%;
    left:50%;
    transform:translate(-50%,-50%);
    background:rgba(0,0,0,0.7);
    padding:20px 30px;
    border-radius:15px;
    display:none;
    z-index:20000;
}
</style>
</head>

<body>

<h2>BINGO</h2>

<button id="scanBtn">QRË™≠„ÅøÂèñ„Çä</button>

<div id="bingo-board"></div>

<!-- Áõ§Èù¢Êàª„ÇäÂæå„ÅÆË°®Á§∫„É°„ÉÉ„Çª„Éº„Ç∏ -->
<div id="msg" class="message"></div>

<!-- „Ç´„É°„É©ÁîªÈù¢ -->
<div id="camera-view">
    <video id="video" autoplay playsinline></video>
    <button id="closeCam">Èñâ„Åò„Çã</button>
</div>

<script src="https://unpkg.com/jsqr/dist/jsQR.js"></script>

<script>
// ‚úÖ„Éû„Çπ‰∏ÄË¶ßÔºàFree„ÅØB13Ôºâ
const labels = [];
for (let i=1;i<=25;i++){
    if(i===13) labels.push("FREE");
    else labels.push("B"+i);
}

const board = document.getElementById("bingo-board");

// ‚úÖÁõ§Èù¢‰ΩúÊàê
labels.forEach(lbl=>{
    const div = document.createElement("div");
    div.className="cell";
    div.textContent = lbl==="FREE" ? "" : lbl.replace("B","");
    div.id = lbl;
    board.appendChild(div);
});

// ‚úÖFREE„Éû„Çπ„ÅØÊúÄÂàù„Åã„ÇâÂÖâ„Çã
document.getElementById("FREE").classList.add("glow");

const video = document.getElementById("video");
const camView = document.getElementById("camera-view");
const msg = document.getElementById("msg");

let scanned = new Set(["FREE"]);
let stream = null;

// ‚úÖQRË™≠Âèñ‚Üí1ÂõûÊàêÂäü„Åó„Åü„ÇâÂç≥Áõ§Èù¢„Å∏Êàª„Çã
const scanBtn = document.getElementById("scanBtn");
scanBtn.onclick = async () => {
    camView.style.display="flex";
    try {
        stream = await navigator.mediaDevices.getUserMedia({
            video: { facingMode:"environment" }
        });
        video.srcObject = stream;
        requestAnimationFrame(tick);
    } catch(e){ alert("„Ç´„É°„É©„Ç¢„ÇØ„Çª„Çπ‰∏çÂèØ"); }
};

// ‚úÖ„Ç´„É°„É©Èñâ„Åò„Çã
document.getElementById("closeCam").onclick = () => {
    closeCamera();
};

// ‚úÖÊò†ÂÉè„Éï„É¨„Éº„É†Ëß£Êûê
function tick(){
    if(camView.style.display!=="flex") return;

    const cvs = document.createElement("canvas");
    cvs.width = video.videoWidth;
    cvs.height = video.videoHeight;
    const ctx = cvs.getContext("2d");
    ctx.drawImage(video,0,0,cvs.width,cvs.height);
    const img = ctx.getImageData(0,0,cvs.width,cvs.height);
    const code = jsQR(img.data, img.width, img.height);

    if(code){
        const data = code.data.trim();
        if(labels.includes(data) && !scanned.has(data)){
            scanned.add(data);
            markCell(data);
            closeCamera();
            return;
        }
    }
    requestAnimationFrame(tick);
}

// ‚úÖ„Éû„ÇπÂÖâ„Çâ„ÅõÔºã„Éì„É≥„Ç¥Âà§ÂÆö
function markCell(id){
    const cell = document.getElementById(id);
    if(cell){
        cell.classList.add("glow");
        showMessage(id);
        checkBingo();
    }
}

// ‚úÖÊºîÂá∫„É°„ÉÉ„Çª„Éº„Ç∏
function showMessage(id){
    msg.textContent = id==="FREE" ? "FREE!" : id;
    msg.style.display="block";
    setTimeout(()=>msg.style.display="none",1200);
}

// ‚úÖ„Ç´„É°„É©ÁµÇ‰∫Ü‚ÜíÁõ§Èù¢
function closeCamera(){
    camView.style.display="none";
    if(stream){
        stream.getTracks().forEach(t=>t.stop());
        stream=null;
    }
}

// ‚úÖ„Éì„É≥„Ç¥Âà§ÂÆö
function checkBingo(){
    const win = [
        [1,2,3,4,5],[6,7,8,9,10],[11,12,13,14,15],[16,17,18,19,20],[21,22,23,24,25],
        [1,6,11,16,21],[2,7,12,17,22],[3,8,13,18,23],[4,9,14,19,24],[5,10,15,20,25],
        [1,7,13,19,25],[5,9,13,17,21]
    ];
    let bingoCount = 0;

    win.forEach(line=>{
        if(line.every(i => {
            let id = (i===13)?"FREE":("B"+i);
            return scanned.has(id);
        })) bingoCount++;
    });

    if(bingoCount>0){
        let text = bingoCount===1?"BINGO!":
                  bingoCount===2?"DOUBLE BINGO!":
                  "üéâTRIPLE BINGO!üéâ";
        msg.textContent = text;
        msg.style.display="block";
        setTimeout(()=>msg.style.display="none",2000);
    }

    if(scanned.size===25){
        msg.textContent="üéäCOMPLETE!!üéä";
        msg.style.display="block";
    }
}
</script>

</body>
</html>
