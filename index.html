<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, viewport-fit=cover">
<title>ÂßøÂ∑ù„Éì„É≥„Ç¥</title>
<style>
  body {
    font-family: 'Hiragino Sans', sans-serif;
    display: flex;
    flex-direction: column;
    align-items: center;
    justify-content: flex-start;
    height: 100vh;
    margin: 0;
    background: #f9f9f9;
    overflow: hidden;
    -webkit-user-select: none;
    user-select: none;
  }

  h1 {
    font-size: 24px;
    color: #333;
    margin: 10px 0;
  }

  .bingo {
    display: grid;
    grid-template-columns: repeat(5, min(18vw, 60px));
    grid-gap: min(2vw, 8px);
  }

  .cell {
    width: min(18vw, 60px);
    height: min(18vw, 60px);
    background: white;
    border: 2px solid #ccc;
    border-radius: 8px;
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: min(4vw, 16px);
    cursor: pointer;
    transition: all 0.2s;
  }

  .cell.active {
    background: #fdd835;
    color: white;
    border-color: #fbc02d;
    box-shadow: 0 0 10px rgba(255, 215, 0, 0.7);
    transform: scale(1.06);
  }

  button {
    margin: 14px;
    padding: 12px 22px;
    font-size: 18px;
    border: none;
    border-radius: 10px;
    cursor: pointer;
    background: #4caf50;
    color: white;
  }

  #cameraView {
    position: fixed;
    inset: 0;
    width: 100%;
    height: 100%;
    background: black;
    display: none;
    justify-content: center;
    align-items: center;
    z-index: 100;
  }

  video {
    width: 100%;
    height: 100%;
    object-fit: cover;
  }

  .message {
    position: fixed;
    bottom: 20px;
    font-size: 26px;
    font-weight: bold;
    color: #e91e63;
    display: none;
    z-index: 200;
    text-shadow: 0 0 6px white;
  }
</style>
</head>

<body>

<h1>ÂßøÂ∑ù„Éì„É≥„Ç¥</h1>

<button id="scanBtn">QR„Ç≥„Éº„Éâ„ÇíË™≠„ÅøÂèñ„Çã</button>

<div class="bingo" id="bingo"></div>
<div class="message" id="message"></div>

<div id="cameraView">
  <video id="camera" autoplay playsinline></video>
</div>

<script src="https://unpkg.com/jsqr/dist/jsQR.js"></script>

<script>
const bingo = document.getElementById('bingo');
const message = document.getElementById('message');
const cameraView = document.getElementById('cameraView');
const video = document.getElementById('camera');
const scanBtn = document.getElementById('scanBtn');

const size = 5;
let cells = [];
let bingoLines = new Set();
let stream = null;

// „Éû„ÇπÁîüÊàê
for (let i = 0; i < size * size; i++) {
  const div = document.createElement('div');
  div.classList.add('cell');

  const col = Math.floor(i / size);
  const row = i % size;
  div.textContent = `B${i + 1}`;

  // FREE„Éû„ÇπÔºà‰∏≠Â§ÆÔºâ
  if (i === 12) {
    div.textContent = "FREE";
    div.classList.add("active");
  }

  bingo.appendChild(div);
  cells.push(div);
}

// „Ç´„É°„É©ÈñãÂßã
scanBtn.addEventListener('click', async () => {
  try {
    stream = await navigator.mediaDevices.getUserMedia({
      video: { facingMode: "environment" }
    });
    video.srcObject = stream;
    cameraView.style.display = "flex";
    scanLoop();
  } catch (e) {
    alert("„Ç´„É°„É©„ÅÆ„Ç¢„ÇØ„Çª„Çπ„ÅåÊãíÂê¶„Åï„Çå„Å¶„ÅÑ„Åæ„Åô");
  }
});

// „É´„Éº„ÉóË™≠„ÅøÂèñ„Çä
function scanLoop() {
  if (cameraView.style.display === "none") return;

  const canvas = document.createElement("canvas");
  canvas.width = video.videoWidth;
  canvas.height = video.videoHeight;
  const ctx = canvas.getContext("2d");
  ctx.drawImage(video, 0, 0);

  const imageData = ctx.getImageData(0, 0, canvas.width, canvas.height);
  const code = jsQR(imageData.data, canvas.width, canvas.height);

  if (code && code.data.startsWith("B")) {
    const num = parseInt(code.data.substring(1));
    activateCell(num - 1);
    closeCamera();
    return;
  }

  requestAnimationFrame(scanLoop);
}

function closeCamera() {
  if (stream) {
    stream.getTracks().forEach(t => t.stop());
  }
  cameraView.style.display = "none";
}

// „Éû„ÇπÂÖâ„Çâ„Åõ„Çã
function activateCell(i) {
  if (i < 0 || i >= size * size) return;
  if (i === 12) return; // FREE„ÅØÂ∏∏„Å´ÁÇπÁÅØÁä∂ÊÖã
  if (cells[i].classList.contains("active")) return;

  cells[i].classList.add("active");
  checkBingo();
}

// Âà§ÂÆö
function checkBingo() {
  const grid = cells.map(c => c.classList.contains("active"));
  let newLines = 0;
  let totalCells = grid.filter(Boolean).length;

  // Ê®™
  for (let r = 0; r < size; r++) {
    let line = [];
    for (let c = 0; c < size; c++) line.push(r * size + c);
    checkLine(line);
  }

  // Á∏¶
  for (let c = 0; c < size; c++) {
    let line = [];
    for (let r = 0; r < size; r++) line.push(r * size + c);
    checkLine(line);
  }

  // Êñú„ÇÅ
  checkLine([0, 6, 12, 18, 24]);
  checkLine([4, 8, 12, 16, 20]);

  function checkLine(line) {
    if (line.every(i => grid[i])) {
      let key = line.join("-");
      if (!bingoLines.has(key)) {
        bingoLines.add(key);
        showMessage(`${bingoLines.size}„É©„Ç§„É≥ BINGO! üéâ`, 2000);
      }
    }
  }

  if (grid.every(Boolean)) {
    showMessage("üéØ COMPLETE! üéØ", 999999);
  }
}

// „É°„ÉÉ„Çª„Éº„Ç∏Ë°®Á§∫
function showMessage(text, ms) {
  message.textContent = text;
  message.style.display = "block";
  if (ms < 900000) {
    setTimeout(() => {
      message.style.display = "none";
    }, ms);
  }
}
</script>

</body>
</html>
